<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„œì§„í…Œí¬ AI ì¼ì • ê´€ë¦¬</title>
    <style>
        body { 
            font-family: 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', sans-serif; 
            max-width: 600px; 
            margin: 0 auto; 
            padding: 20px; 
            background-color: #f4f7f9;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #007bff;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        button {
            padding: 10px 20px; 
            cursor: pointer; 
            margin-top: 10px; 
            border: none;
            border-radius: 5px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        #start-voice-btn { background-color: #007bff; color: white; }
        #start-voice-btn:hover { background-color: #0056b3; }
        #submit-text-btn { background-color: #28a745; color: white; }
        #submit-text-btn:hover { background-color: #1e7e34; }
        #voice-result { font-weight: bold; color: #d9534f; display: block; margin-top: 5px; }
        #status-message { 
            color: #007bff; margin-top: 15px; font-size: 1.1em; padding: 10px; 
            border: 1px solid #cce5ff; background-color: #e2f0ff; border-radius: 5px; 
        }
        input[type="text"] {
            padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; 
            box-sizing: border-box; width: 70%;
        }
        label { display: block; margin-top: 15px; margin-bottom: 5px; font-weight: bold; }
        .calendar-container {
            margin-top: 30px; position: relative; padding-bottom: 75%; height: 0; overflow: hidden;
        }
        .calendar-container iframe {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        }
    </style>
</head>
<body>
    <h1>ğŸ“ ì„œì§„í…Œí¬ AI ì¼ì • ê´€ë¦¬</h1>
    
    <button id="start-voice-btn">ğŸ¤ ë§í•˜ê¸°</button>
    <p>ì¸ì‹ëœ ë‚´ìš©: <span id="voice-result"></span></p>

    <hr>

    <label for="text-input">í…ìŠ¤íŠ¸ ì…ë ¥:</label>
    <input type="text" id="text-input" placeholder="ì˜ˆ: ë‚´ì¼ ì˜¤í›„ 3ì‹œì— ë³´ê³ ì„œ ì œì¶œí•˜ê¸°">
    <button id="submit-text-btn">í•  ì¼ ì¶”ê°€</button>

    <p id="status-message">ì—°ë™ì„ ìœ„í•´ [ë§í•˜ê¸°] ë˜ëŠ” [í•  ì¼ ì¶”ê°€] ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
    
    <div class="calendar-container">
        <iframe src="https://calendar.google.com/calendar/embed?src=cce03f167bf28bafd3795833209784265eadca0ed8138cae7d9024470ad36c66%40group.calendar.google.com&ctz=Asia%2FSeoul" style="border: 0" frameborder="0" scrolling="no"></iframe>
    </div>

    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>

    <script>
        /* ============================================================
           ğŸš¨ [ì„¤ì •] ë°©ê¸ˆ ë§Œë“  ìƒˆ í´ë¼ì´ì–¸íŠ¸ IDë¥¼ ì•„ë˜ì— ë„£ìœ¼ì„¸ìš”.
           (ì´ë©”ì¼ì´ë‚˜ ìº˜ë¦°ë” ì£¼ì†Œ ê¸ˆì§€! ìˆ«ì-ì˜ì–´.apps... í˜•ì‹ì´ì–´ì•¼ í•¨)
           ============================================================ */
        const CLIENT_ID = '1049915608396-i3jn8jrm24bc9mkagdtokk3rfa3li513.apps.googleusercontent.com'; 

        const SCOPES = 'https://www.googleapis.com/auth/tasks'; 
        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/tasks/v1/rest"];

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;

        const statusMessage = document.getElementById('status-message');
        const voiceResult = document.getElementById('voice-result');
        const textInput = document.getElementById('text-input');

        // 1. GAPI (Tasks API ê¸°ëŠ¥) ë¡œë“œ
        function gapiLoaded() {
            gapi.load('client', intializeGapiClient);
        }

        async function intializeGapiClient() {
            await gapi.client.init({
                discoveryDocs: DISCOVERY_DOCS,
            });
            gapiInited = true;
            maybeEnableButtons();
        }

        // 2. GIS (ìƒˆë¡œìš´ ë¡œê·¸ì¸ ë°©ì‹) ë¡œë“œ
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '', // ë‚˜ì¤‘ì— ìš”ì²­ ì‹œ ì •ì˜
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                statusMessage.textContent = "âœ… ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ. ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”.";
            }
        }

        // 3. ì¸ì¦ ë° ì‘ì—… ì²˜ë¦¬ í•¨ìˆ˜
        function handleAuthAndAction(actionCallback) {
            // ì´ë¯¸ í† í°ì´ ìˆìœ¼ë©´ ë°”ë¡œ ì‹¤í–‰
            if (gapi.client.getToken() !== null) {
                actionCallback();
                return;
            }

            // í† í°ì´ ì—†ìœ¼ë©´ ë¡œê·¸ì¸ ì°½ ë„ìš°ê¸°
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    throw (resp);
                }
                statusMessage.textContent = "âœ… ë¡œê·¸ì¸ ì„±ê³µ! ì‘ì—…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤...";
                actionCallback();
            };
            tokenClient.requestAccessToken({prompt: 'consent'});
        }

        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ---
        
        // ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì‹œì‘
        gapiLoaded();
        gisLoaded();

        document.getElementById('start-voice-btn').onclick = () => {
            handleAuthAndAction(startVoiceRecognition);
        };

        document.getElementById('submit-text-btn').onclick = () => {
            handleAuthAndAction(() => processSchedule(textInput.value));
        };


        // --- ê¸°ëŠ¥ ë¡œì§ (ìŒì„± ì¸ì‹ & í• ì¼ ì¶”ê°€) ---

        function startVoiceRecognition() {
            if (!('webkitSpeechRecognition' in window)) {
                statusMessage.textContent = 'âš ï¸ ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                return;
            }
            const recognition = new webkitSpeechRecognition();
            recognition.lang = 'ko-KR';
            recognition.continuous = false;
            recognition.interimResults = false;

            statusMessage.textContent = 'ğŸ¤ ë“£ê³  ìˆìŠµë‹ˆë‹¤...';
            recognition.start();

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                voiceResult.textContent = transcript;
                processSchedule(transcript); 
            };
            recognition.onerror = (event) => {
                statusMessage.textContent = `âŒ ìŒì„± ì¸ì‹ ì˜¤ë¥˜: ${event.error}`;
            };
        }

        function processSchedule(text) {
            if (!text.trim()) {
                statusMessage.textContent = 'âš ï¸ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.';
                return;
            }

            let title = text.replace(/ë‚´ì¼|ì˜¤ëŠ˜/g, '').trim();
            let dueDate = null; 

            // ë‚ ì§œ ê³„ì‚°
            if (text.includes('ë‚´ì¼')) {
                dueDate = new Date();
                dueDate.setDate(dueDate.getDate() + 1);
                dueDate.setHours(0, 0, 0, 0); 
            } else if (text.includes('ì˜¤ëŠ˜')) {
                dueDate = new Date();
                dueDate.setHours(0, 0, 0, 0); 
            }
            
            // ì‹œê°„ íŒŒì‹±
            const timeMatch = text.match(/(ì˜¤ì „|ì˜¤í›„)?\s*(\d{1,2})\s*ì‹œ/); 
            if (timeMatch) {
                if (!dueDate) dueDate = new Date();
                let hour = parseInt(timeMatch[2]);
                const ampm = timeMatch[1];
                if (ampm === 'ì˜¤í›„' && hour < 12) hour += 12;
                else if (ampm === 'ì˜¤ì „' && hour === 12) hour = 0;
                dueDate.setHours(hour, 0, 0, 0);
                title = title.replace(timeMatch[0], '').replace(/(ì˜¤ì „|ì˜¤í›„)?\s*\d{1,2}\s*ì‹œ/g, '').replace(/ì—|ì‹œê°„ì—|ì¡ì•„ì¤˜|ì¼ì •|ë¯¸íŒ…|ì•½ì†|ì œì¶œí•˜ê¸°/g, '').trim();
            }

            title = title || 'ìƒˆë¡œìš´ í•  ì¼';
            const task = { 'title': title };
            if (dueDate) task.due = dueDate.toISOString();
            
            statusMessage.textContent = `â³ "${title}" êµ¬ê¸€ íƒœìŠ¤í¬ì— ì €ì¥ ì¤‘...`;

            gapi.client.tasks.tasks.insert({
                'tasklist': '@default',
                'resource': task
            }).then((response) => {
                statusMessage.textContent = `âœ… ì €ì¥ ì™„ë£Œ! (${response.result.title})`;
                voiceResult.textContent = '';
                textInput.value = '';
            }).catch((err) => {
                statusMessage.textContent = `âŒ ì €ì¥ ì‹¤íŒ¨: ${err.result.error.message}`;
            });
        }
    </script>
</body>
</html>
