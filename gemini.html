<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„œì§„í…Œí¬ AI ì¼ì • ê´€ë¦¬</title>
    <style>
        body { 
            font-family: 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', sans-serif; 
            max-width: 600px; 
            margin: 0 auto; 
            padding: 20px; 
            background-color: #f4f7f9;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #007bff;
            padding-bottom: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        /* --- 1. ë²„íŠ¼ ë°°ì¹˜ ìˆ˜ì • (Flexbox) --- */
        .header-buttons {
            display: flex;
            justify-content: space-between; /* ì–‘ ë ì •ë ¬ */
            align-items: center;
            margin-bottom: 20px;
        }
        
        button {
            padding: 10px 20px; 
            cursor: pointer; 
            border: none;
            border-radius: 5px;
            font-weight: bold;
            transition: background-color 0.3s;
            font-size: 14px;
        }
        button:disabled {
            background-color: #cccccc !important;
            cursor: not-allowed;
            color: #666666 !important;
        }

        /* ë§í•˜ê¸° ë²„íŠ¼ (ì™¼ìª½) */
        #start-voice-btn { background-color: #007bff; color: white; }
        #start-voice-btn:hover { background-color: #0056b3; }

        /* ë¡œê·¸ì¸ ë²„íŠ¼ (ì˜¤ë¥¸ìª½) */
        #login-btn { background-color: #6c757d; color: white; }
        #login-btn:hover { background-color: #5a6268; }
        #login-btn.logout-mode { background-color: #dc3545; } /* ë¡œê·¸ì•„ì›ƒì€ ë¹¨ê°• */
        
        #submit-text-btn { background-color: #28a745; color: white; width: 100%; margin-top: 5px;}
        #submit-text-btn:hover { background-color: #1e7e34; }

        /* ì…ë ¥ ì˜ì—­ ìŠ¤íƒ€ì¼ */
        .input-area { margin-bottom: 20px; }
        input[type="text"] {
            padding: 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; 
            box-sizing: border-box; width: 100%; margin-bottom: 5px;
        }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        
        /* ê²°ê³¼ ë° ìƒíƒœ ë©”ì‹œì§€ */
        #voice-result { 
            font-weight: bold; color: #d9534f; display: block; margin-bottom: 10px; min-height: 20px; 
        }
        #status-message { 
            color: #007bff; margin-top: 10px; font-size: 0.95em; padding: 10px; 
            border: 1px solid #cce5ff; background-color: #e2f0ff; border-radius: 5px; text-align: center;
        }

        /* ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .task-section {
            background: white;
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .task-section h3 {
            margin-top: 0;
            font-size: 1.1em;
            color: #444;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        ul { padding-left: 20px; margin-bottom: 0; }
        li { margin-bottom: 8px; color: #555; line-height: 1.4; }
        
        .time-badge {
            font-size: 0.8em; background-color: #e2f0ff; color: #007bff;
            padding: 2px 6px; border-radius: 4px; margin-right: 6px; font-weight: bold;
        }
        .my-badge {
            font-size: 0.7em; background-color: #28a745; color: white;
            padding: 1px 4px; border-radius: 3px; margin-left: 5px; vertical-align: middle;
        }

        /* ìº˜ë¦°ë” iframe */
        .calendar-container {
            margin-top: 30px; position: relative; padding-bottom: 75%; height: 0; overflow: hidden;
            border: 1px solid #ccc; border-radius: 8px;
        }
        .calendar-container iframe {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        }
        
        /* ì‚¬ìš©ì ì •ë³´ í‘œì‹œ */
        #user-info {
            text-align: right; font-size: 0.8em; color: #888; margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <h1>ğŸ“… ì„œì§„í…Œí¬ AI ì¼ì • ê´€ë¦¬</h1>
    
    <div id="user-info"></div>

    <div class="header-buttons">
        <button id="start-voice-btn" disabled>ğŸ¤ ë§í•˜ê¸°</button>
        <button id="login-btn" disabled>ğŸ”„ ë¡œë”© ì¤‘...</button>
    </div>

    <div class="input-area">
        <p>ì¸ì‹ëœ ë‚´ìš©: <span id="voice-result"></span></p>
        <label for="text-input">í…ìŠ¤íŠ¸ ì…ë ¥:</label>
        <input type="text" id="text-input" placeholder="ì˜ˆ: ë‚´ì¼ ì˜¤í›„ 3ì‹œì— ë¯¸íŒ… ì¼ì • ì¡ì•„ì¤˜">
        <button id="submit-text-btn" disabled>ì¼ì • ì¶”ê°€</button>
    </div>

    <p id="status-message">â³ ì‹œìŠ¤í…œ ì—°ê²° ëŒ€ê¸° ì¤‘...</p>
    
    <div class="task-section">
        <h3>â˜€ï¸ ì˜¤ëŠ˜ ë‚˜ì˜ ì¼ì • (Today)</h3>
        <ul id="today-list"><li>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</li></ul>
    </div>

    <div class="task-section">
        <h3>ğŸ—“ï¸ ì´ë²ˆ ì£¼ ë‚˜ì˜ ì¼ì • (This Week)</h3>
        <ul id="week-list"><li>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</li></ul>
    </div>

    <div class="calendar-container">
        <iframe src="https://calendar.google.com/calendar/embed?src=cce03f167bf28bafd3795833209784265eadca0ed8138cae7d9024470ad36c66%40group.calendar.google.com&ctz=Asia%2FSeoul" style="border: 0" frameborder="0" scrolling="no"></iframe>
    </div>

    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>

    <script>
        const CLIENT_ID = '1049915608396-i3jn8jrm24bc9mkagdtokk3rfa3li513.apps.googleusercontent.com'; 
        const CALENDAR_ID = 'cce03f167bf28bafd3795833209784265eadca0ed8138cae7d9024470ad36c66@group.calendar.google.com';

        // 'profile'ê³¼ 'email' ìŠ¤ì½”í”„ë¥¼ ì¶”ê°€í•˜ì—¬ ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜´
        const SCOPES = 'https://www.googleapis.com/auth/calendar.events https://www.googleapis.com/auth/userinfo.email'; 
        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"];

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let userEmail = ''; // í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì´ë©”ì¼

        const statusMessage = document.getElementById('status-message');
        const loginBtn = document.getElementById('login-btn');
        const voiceBtn = document.getElementById('start-voice-btn');
        const submitBtn = document.getElementById('submit-text-btn');
        const userInfoDiv = document.getElementById('user-info');
        const todayList = document.getElementById('today-list');
        const weekList = document.getElementById('week-list');

        function gapiLoaded() { gapi.load('client', intializeGapiClient); }
        function gisLoaded() { 
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '', 
            });
            gisInited = true;
            maybeEnableButtons();
        }

        async function intializeGapiClient() {
            await gapi.client.init({ discoveryDocs: DISCOVERY_DOCS });
            gapiInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                // ì„¸ì…˜ ë³µêµ¬ ì‹œë„
                const savedToken = localStorage.getItem('access_token');
                
                if (savedToken) {
                    gapi.client.setToken({access_token: savedToken});
                    // í† í° ìœ íš¨ì„± ê²€ì¦ ê²¸ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                    fetchUserInfo(true);
                } else {
                    setLoginState(false);
                }
            }
        }

        // ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸° ë° ìƒíƒœ ì—…ë°ì´íŠ¸
        function fetchUserInfo(isAutoLogin) {
            statusMessage.textContent = "ğŸ”„ ì‚¬ìš©ì ì •ë³´ í™•ì¸ ì¤‘...";
            // Google Oauth2 Info API í˜¸ì¶œ
            fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
                headers: {
                    'Authorization': `Bearer ${gapi.client.getToken().access_token}`
                }
            })
            .then(response => {
                if (!response.ok) throw new Error('Session expired');
                return response.json();
            })
            .then(data => {
                userEmail = data.email; // ì´ë©”ì¼ ì €ì¥
                userInfoDiv.textContent = `${data.name || data.email}ë‹˜ ë¡œê·¸ì¸ ì¤‘`;
                setLoginState(true);
                loadEventsList(); // ë¦¬ìŠ¤íŠ¸ ë¡œë“œ
                if(!isAutoLogin) statusMessage.textContent = `âœ… í™˜ì˜í•©ë‹ˆë‹¤, ${data.name}ë‹˜!`;
            })
            .catch(error => {
                console.log("ì„¸ì…˜ ë§Œë£Œ ë˜ëŠ” ì˜¤ë¥˜", error);
                handleLogout(); // ì„¸ì…˜ ë§Œë£Œ ì‹œ ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
            });
        }

        function setLoginState(isLoggedIn) {
            if (isLoggedIn) {
                loginBtn.textContent = "ğŸšª ë¡œê·¸ì•„ì›ƒ";
                loginBtn.classList.add('logout-mode');
                loginBtn.disabled = false;
                voiceBtn.disabled = false;
                submitBtn.disabled = false;
                loginBtn.onclick = handleLogout;
            } else {
                loginBtn.textContent = "ğŸ”‘ ë¡œê·¸ì¸";
                loginBtn.classList.remove('logout-mode');
                loginBtn.disabled = false;
                voiceBtn.disabled = true;
                submitBtn.disabled = true;
                loginBtn.onclick = handleLogin;
                userInfoDiv.textContent = "";
                todayList.innerHTML = '<li>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</li>';
                weekList.innerHTML = '<li>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</li>';
                statusMessage.textContent = "âœ… ì¤€ë¹„ ì™„ë£Œ. ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.";
                userEmail = '';
            }
        }

        function handleLogin() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) throw (resp);
                // í† í° ì €ì¥
                localStorage.setItem('access_token', resp.access_token);
                fetchUserInfo(false);
            };
            tokenClient.requestAccessToken({prompt: 'consent'});
        }

        function handleLogout() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
            }
            localStorage.removeItem('access_token');
            setLoginState(false);
            statusMessage.textContent = "ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.";
        }

        // --- ì¼ì • ë¡œì§ ---

        // ì¼ì • ì¶”ê°€
        function processSchedule(text) {
            if (!text.trim()) { statusMessage.textContent = 'âš ï¸ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.'; return; }

            let summary = text;
            let startDate = new Date();
            
            if (text.includes('ë‚´ì¼')) {
                startDate.setDate(startDate.getDate() + 1);
                summary = summary.replace('ë‚´ì¼', '').trim();
            } else if (text.includes('ì˜¤ëŠ˜')) {
                summary = summary.replace('ì˜¤ëŠ˜', '').trim();
            }

            const timeMatch = text.match(/(ì˜¤ì „|ì˜¤í›„)?\s*(\d{1,2})\s*ì‹œ/); 
            if (timeMatch) {
                let hour = parseInt(timeMatch[2]);
                if (timeMatch[1] === 'ì˜¤í›„' && hour < 12) hour += 12;
                else if (timeMatch[1] === 'ì˜¤ì „' && hour === 12) hour = 0;
                startDate.setHours(hour, 0, 0, 0);
                summary = summary.replace(timeMatch[0], '').replace(/ì—|ì‹œê°„ì—|ì¡ì•„ì¤˜|ì¼ì •|ë¯¸íŒ…/g, '').trim();
            } else {
                startDate.setHours(startDate.getHours() + 1, 0, 0, 0);
            }

            let endDate = new Date(startDate);
            endDate.setHours(startDate.getHours() + 1);

            const event = {
                'summary': summary || 'ìƒˆë¡œìš´ ì¼ì •',
                'start': { 'dateTime': startDate.toISOString() },
                'end': { 'dateTime': endDate.toISOString() },
                // ìƒì„±ì ì •ë³´ë¥¼ ëª…í™•íˆ í•˜ê¸° ìœ„í•´ descriptionì— ì´ë©”ì¼ ì¶”ê°€ (ì˜µì…˜)
                'description': `Created by: ${userEmail}` 
            };

            statusMessage.textContent = `â³ ì €ì¥ ì¤‘...`;

            gapi.client.calendar.events.insert({
                'calendarId': CALENDAR_ID, 
                'resource': event
            }).then((response) => {
                statusMessage.textContent = `âœ… ì €ì¥ ì™„ë£Œ! (${summary})`;
                document.getElementById('voice-result').textContent = '';
                document.getElementById('text-input').value = '';
                
                loadEventsList(); 
                const iframe = document.querySelector('.calendar-container iframe');
                iframe.src = iframe.src; 
                
            }).catch((err) => {
                statusMessage.textContent = `âŒ ì‹¤íŒ¨: ${err.result.error.message}`;
            });
        }

        // ì¼ì • ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (í•„í„°ë§ ì ìš©)
        async function loadEventsList() {
            if (!userEmail) return;

            try {
                const now = new Date();
                const startOfWeek = new Date(now); startOfWeek.setHours(0,0,0,0);
                const endOfWeek = new Date(now); endOfWeek.setDate(now.getDate() + 7);

                const response = await gapi.client.calendar.events.list({
                    'calendarId': CALENDAR_ID,
                    'timeMin': startOfWeek.toISOString(),
                    'timeMax': endOfWeek.toISOString(),
                    'showDeleted': false,
                    'singleEvents': true,
                    'orderBy': 'startTime'
                });

                const events = response.result.items || [];
                
                todayList.innerHTML = '';
                weekList.innerHTML = '';
                let todayCount = 0;
                let weekCount = 0;

                events.forEach(event => {
                    // ğŸ¯ ì¤‘ìš”: ì‘ì„±ìê°€ 'ë‚˜(userEmail)'ì¸ ê²½ìš°ë§Œ ë¦¬ìŠ¤íŠ¸ì— í‘œì‹œ
                    // (êµ¬ê¸€ API creator í•„ë“œê°€ ìº˜ë¦°ë” ì„¤ì •ì— ë”°ë¼ ownerë¡œ ë®ì–´ì”Œì›Œì§ˆ ìˆ˜ ìˆìœ¼ë¯€ë¡œ
                    // descriptionì´ë‚˜ creator.emailì„ í™•ì¸)
                    const creatorEmail = event.creator.email;
                    
                    // ë‚´ ì´ë©”ì¼ê³¼ ì‘ì„±ìê°€ ê°™ì„ ë•Œë§Œ í‘œì‹œ
                    if (creatorEmail === userEmail) {
                        const start = event.start.dateTime || event.start.date;
                        const dateObj = new Date(start);
                        const timeStr = dateObj.getHours().toString().padStart(2, '0') + ':' + 
                                        dateObj.getMinutes().toString().padStart(2, '0');
                        
                        const li = document.createElement('li');
                        const dateStr = (dateObj.getMonth()+1) + "/" + dateObj.getDate();
                        
                        // ì˜¤ëŠ˜ ì¼ì •
                        if (dateObj.toDateString() === now.toDateString()) {
                            li.innerHTML = `<span class="time-badge">${timeStr}</span> ${event.summary}`;
                            todayList.appendChild(li);
                            todayCount++;
                        } else {
                            // ì´ë²ˆì£¼ ì¼ì •
                            li.innerHTML = `<span class="time-badge">${dateStr} ${timeStr}</span> ${event.summary}`;
                            weekList.appendChild(li);
                            weekCount++;
                        }
                    }
                });

                if (todayCount === 0) todayList.innerHTML = '<li>ë“±ë¡í•œ ë‚˜ì˜ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
                if (weekCount === 0) weekList.innerHTML = '<li>ë“±ë¡í•œ ë‚˜ì˜ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</li>';

            } catch (err) {
                console.error(err);
                statusMessage.textContent = "âŒ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨";
            }
        }

        function startVoiceRecognition() {
            if (!('webkitSpeechRecognition' in window)) {
                statusMessage.textContent = 'âš ï¸ ìŒì„± ì¸ì‹ ë¯¸ì§€ì›'; return;
            }
            const recognition = new webkitSpeechRecognition();
            recognition.lang = 'ko-KR';
            recognition.continuous = false;
            recognition.interimResults = false;

            statusMessage.textContent = 'ğŸ¤ ë“£ê³  ìˆìŠµë‹ˆë‹¤...';
            recognition.start();

            recognition.onresult = (event) => {
                const text = event.results[0][0].transcript;
                document.getElementById('voice-result').textContent = text;
                processSchedule(text);
            };
            recognition.onerror = (event) => {
                statusMessage.textContent = `âŒ ì˜¤ë¥˜: ${event.error}`;
            };
        }

        voiceBtn.onclick = startVoiceRecognition;
        submitBtn.onclick = () => processSchedule(document.getElementById('text-input').value);

        gapiLoaded();
        gisLoaded();
    </script>
</body>
</html>
