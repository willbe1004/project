<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„œì§„í…Œí¬ AI ì¼ì • ê´€ë¦¬</title>
    <style>
        body { 
            font-family: 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', sans-serif; 
            max-width: 600px; 
            margin: 0 auto; 
            padding: 20px; 
            background-color: #f4f7f9;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #007bff;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        button {
            padding: 10px 20px; 
            cursor: pointer; 
            margin-top: 10px; 
            border: none;
            border-radius: 5px;
            font-weight: bold;
            transition: background-color 0.3s;
            margin-right: 5px;
        }
        /* ë¹„í™œì„±í™” ëœ ë²„íŠ¼ ìŠ¤íƒ€ì¼ (íšŒìƒ‰) */
        button:disabled {
            background-color: #cccccc !important;
            cursor: not-allowed;
            color: #666666 !important;
        }

        #start-voice-btn { background-color: #007bff; color: white; }
        #start-voice-btn:hover { background-color: #0056b3; }
        
        #submit-text-btn { background-color: #28a745; color: white; }
        #submit-text-btn:hover { background-color: #1e7e34; }

        #login-btn { background-color: #6c757d; color: white; }
        #login-btn:hover { background-color: #5a6268; }
        
        .task-section {
            background: white;
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .task-section h3 {
            margin-top: 0;
            color: #444;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        ul { padding-left: 20px; }
        li { margin-bottom: 5px; color: #555; }
        .date-badge {
            font-size: 0.8em;
            background-color: #eee;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
            color: #666;
        }

        #voice-result { font-weight: bold; color: #d9534f; display: block; margin-top: 5px; }
        #status-message { 
            color: #007bff; margin-top: 15px; font-size: 1.1em; padding: 10px; 
            border: 1px solid #cce5ff; background-color: #e2f0ff; border-radius: 5px; 
        }
        input[type="text"] {
            padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; 
            box-sizing: border-box; width: 70%;
        }
        label { display: block; margin-top: 15px; margin-bottom: 5px; font-weight: bold; }
        
        .calendar-container {
            margin-top: 30px; position: relative; padding-bottom: 75%; height: 0; overflow: hidden;
        }
        .calendar-container iframe {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        }
    </style>
</head>
<body>
    <h1>ğŸ“ ì„œì§„í…Œí¬ AI ì¼ì • ê´€ë¦¬</h1>
    
    <button id="login-btn" disabled>ğŸ”„ êµ¬ê¸€ ì—°ê²° ì¤‘...</button>
    <br><br>

    <button id="start-voice-btn" disabled>ğŸ¤ ë§í•˜ê¸°</button>
    <p>ì¸ì‹ëœ ë‚´ìš©: <span id="voice-result"></span></p>

    <hr>

    <label for="text-input">í…ìŠ¤íŠ¸ ì…ë ¥:</label>
    <input type="text" id="text-input" placeholder="ì˜ˆ: ë‚´ì¼ ì˜¤í›„ 3ì‹œì— ë³´ê³ ì„œ ì œì¶œí•˜ê¸°">
    <button id="submit-text-btn" disabled>í•  ì¼ ì¶”ê°€</button>

    <p id="status-message">â³ êµ¬ê¸€ ì‹œìŠ¤í…œì— ì—°ê²°í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
    
    <div class="task-section">
        <h3>ğŸ“… ì˜¤ëŠ˜ ì¼ì • (Today)</h3>
        <ul id="today-list"><li>ì‹œìŠ¤í…œ ì—°ê²° ëŒ€ê¸° ì¤‘...</li></ul>
    </div>

    <div class="task-section">
        <h3>ğŸ—“ï¸ ì´ë²ˆ ì£¼ ì¼ì • (This Week)</h3>
        <ul id="week-list"><li>ì‹œìŠ¤í…œ ì—°ê²° ëŒ€ê¸° ì¤‘...</li></ul>
    </div>

    <div class="calendar-container">
        <iframe src="https://calendar.google.com/calendar/embed?src=cce03f167bf28bafd3795833209784265eadca0ed8138cae7d9024470ad36c66%40group.calendar.google.com&ctz=Asia%2FSeoul" style="border: 0" frameborder="0" scrolling="no"></iframe>
    </div>

    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>

    <script>
        /* ==============================================================
           ğŸš¨ [í•„ìˆ˜ í™•ì¸] ì•„ë˜ CLIENT_IDì— ë³¸ì¸ì˜ IDê°€ ë“¤ì–´ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”!
           ë¹„ì–´ìˆë‹¤ë©´ ì•„ê¹Œ ë§Œë“  ìƒˆ IDë¥¼ ê¼­ ë„£ì–´ì•¼ í•©ë‹ˆë‹¤.
           ============================================================== */
        const CLIENT_ID = '1049915608396-4saprmlim0i9t9jv2dhkje4eq6uqqlnr.apps.googleusercontent.com'; 

        const SCOPES = 'https://www.googleapis.com/auth/tasks'; 
        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/tasks/v1/rest"];

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;

        const statusMessage = document.getElementById('status-message');
        const loginBtn = document.getElementById('login-btn');
        const voiceBtn = document.getElementById('start-voice-btn');
        const submitBtn = document.getElementById('submit-text-btn');
        
        const todayList = document.getElementById('today-list');
        const weekList = document.getElementById('week-list');

        // 1. GAPI ë¡œë“œ
        function gapiLoaded() {
            gapi.load('client', intializeGapiClient);
        }

        async function intializeGapiClient() {
            try {
                await gapi.client.init({ discoveryDocs: DISCOVERY_DOCS });
                gapiInited = true;
                maybeEnableButtons();
            } catch (error) {
                statusMessage.textContent = "âŒ êµ¬ê¸€ API ì´ˆê¸°í™” ì‹¤íŒ¨ (ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•˜ì„¸ìš”)";
                console.error(error);
            }
        }

        // 2. GIS ë¡œë“œ
        function gisLoaded() {
            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: '', // ë‚˜ì¤‘ì— ì •ì˜ë¨
                });
                gisInited = true;
                maybeEnableButtons();
            } catch (error) {
                statusMessage.textContent = "âŒ ë¡œê·¸ì¸ ê¸°ëŠ¥ ì´ˆê¸°í™” ì‹¤íŒ¨ (Client IDë¥¼ í™•ì¸í•˜ì„¸ìš”)";
                console.error(error);
            }
        }

        // 3. ì¤€ë¹„ ì™„ë£Œ ì‹œ ë²„íŠ¼ í™œì„±í™”
        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                // ë²„íŠ¼ í™œì„±í™” ë° í…ìŠ¤íŠ¸ ë³€ê²½
                loginBtn.disabled = false;
                voiceBtn.disabled = false;
                submitBtn.disabled = false;
                
                loginBtn.textContent = "ğŸ”„ ë¡œê·¸ì¸ ë° ì¼ì • ë¶ˆëŸ¬ì˜¤ê¸°";
                statusMessage.textContent = "âœ… ì¤€ë¹„ ì™„ë£Œ! [ë¡œê·¸ì¸] ë²„íŠ¼ì„ ë¨¼ì € ëˆŒëŸ¬ì£¼ì„¸ìš”.";
                
                todayList.innerHTML = '<li>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</li>';
                weekList.innerHTML = '<li>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</li>';

                // ì´ë¯¸ ë¡œê·¸ì¸ ëœ ìƒíƒœë¼ë©´ ë°”ë¡œ ë¦¬ìŠ¤íŠ¸ ë¡œë”©
                if (gapi.client.getToken() !== null) {
                    loadTasksList();
                }
            }
        }

        // 4. í†µí•© ì‹¤í–‰ í•¨ìˆ˜
        function handleAuthAndAction(actionCallback) {
            // 1. ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì•„ì§ ë¡œë“œ ì•ˆ ëìœ¼ë©´ ì¤‘ë‹¨
            if (!tokenClient) {
                statusMessage.textContent = "â³ ì•„ì§ êµ¬ê¸€ ê¸°ëŠ¥ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œìš”...";
                return;
            }

            // 2. ì´ë¯¸ ë¡œê·¸ì¸ ìƒíƒœë©´ ë°”ë¡œ ì‹¤í–‰
            if (gapi.client.getToken() !== null) {
                actionCallback();
                return;
            }

            // 3. ë¡œê·¸ì¸ ì‹œë„
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    throw (resp);
                }
                statusMessage.textContent = "âœ… ë¡œê·¸ì¸ ì„±ê³µ!";
                actionCallback();
                // ë¡œê·¸ì¸ ì§í›„ ë¦¬ìŠ¤íŠ¸ ìë™ ê°±ì‹ 
                loadTasksList();
            };

            // 4. ë¡œê·¸ì¸ íŒì—… ë„ìš°ê¸°
            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        // ì‹œì‘
        gapiLoaded();
        gisLoaded();

        // --- ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ---
        loginBtn.onclick = () => { handleAuthAndAction(loadTasksList); };
        voiceBtn.onclick = () => { handleAuthAndAction(startVoiceRecognition); };
        submitBtn.onclick = () => { 
            const text = document.getElementById('text-input').value;
            handleAuthAndAction(() => processSchedule(text)); 
        };

        // --- ê¸°ëŠ¥ í•¨ìˆ˜ë“¤ ---
        async function loadTasksList() {
            statusMessage.textContent = "ğŸ”„ ë°ì´í„° ê°€ì ¸ì˜¤ëŠ” ì¤‘...";
            try {
                const response = await gapi.client.tasks.tasks.list({
                    'tasklist': '@default',
                    'showCompleted': false,
                    'showHidden': false
                });
                
                const tasks = response.result.items || [];
                todayList.innerHTML = '';
                weekList.innerHTML = '';

                const today = new Date();
                today.setHours(0,0,0,0);
                const nextWeek = new Date();
                nextWeek.setDate(today.getDate() + 7);
                nextWeek.setHours(23,59,59,999);

                let todayCount = 0;
                let weekCount = 0;

                tasks.forEach(task => {
                    let li = document.createElement('li');
                    li.textContent = task.title;
                    if (task.due) {
                        const dueDate = new Date(task.due);
                        dueDate.setHours(0,0,0,0);
                        const dateString = (dueDate.getMonth()+1) + "/" + dueDate.getDate();
                        li.innerHTML += ` <span class="date-badge">${dateString}</span>`;

                        if (dueDate.getTime() === today.getTime()) {
                            todayList.appendChild(li);
                            todayCount++;
                        } else if (dueDate > today && dueDate <= nextWeek) {
                            weekList.appendChild(li);
                            weekCount++;
                        }
                    }
                });

                if (todayCount === 0) todayList.innerHTML = '<li>ì˜¤ëŠ˜ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
                if (weekCount === 0) weekList.innerHTML = '<li>ì´ë²ˆ ì£¼ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
                statusMessage.textContent = "âœ… ì¼ì • ëª©ë¡ ê°±ì‹  ì™„ë£Œ";

            } catch (err) {
                console.error(err);
                statusMessage.textContent = "âŒ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
            }
        }

        function startVoiceRecognition() {
            if (!('webkitSpeechRecognition' in window)) {
                statusMessage.textContent = 'âš ï¸ ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.';
                return;
            }
            const recognition = new webkitSpeechRecognition();
            recognition.lang = 'ko-KR';
            recognition.continuous = false;
            recognition.interimResults = false;

            statusMessage.textContent = 'ğŸ¤ ë§ì”€í•´ì£¼ì„¸ìš”...';
            recognition.start();

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                document.getElementById('voice-result').textContent = transcript;
                processSchedule(transcript); 
            };
            recognition.onerror = (event) => {
                statusMessage.textContent = `âŒ ìŒì„± ì¸ì‹ ì˜¤ë¥˜: ${event.error}`;
            };
        }

        function processSchedule(text) {
            if (!text || !text.trim()) { 
                statusMessage.textContent = 'âš ï¸ ë‚´ìš©ì„ ì…ë ¥í•˜ê±°ë‚˜ ë§í•´ì£¼ì„¸ìš”.'; 
                return; 
            }

            let title = text.replace(/ë‚´ì¼|ì˜¤ëŠ˜/g, '').trim();
            let dueDate = null; 

            if (text.includes('ë‚´ì¼')) {
                dueDate = new Date();
                dueDate.setDate(dueDate.getDate() + 1);
                dueDate.setHours(0, 0, 0, 0); 
            } else if (text.includes('ì˜¤ëŠ˜')) {
                dueDate = new Date();
                dueDate.setHours(0, 0, 0, 0); 
            }
            
            const timeMatch = text.match(/(ì˜¤ì „|ì˜¤í›„)?\s*(\d{1,2})\s*ì‹œ/); 
            if (timeMatch) {
                if (!dueDate) dueDate = new Date();
                let hour = parseInt(timeMatch[2]);
                const ampm = timeMatch[1];
                if (ampm === 'ì˜¤í›„' && hour < 12) hour += 12;
                else if (ampm === 'ì˜¤ì „' && hour === 12) hour = 0;
                dueDate.setHours(hour, 0, 0, 0);
                title = title.replace(timeMatch[0], '').replace(/(ì˜¤ì „|ì˜¤í›„)?\s*\d{1,2}\s*ì‹œ/g, '').replace(/ì—|ì‹œê°„ì—|ì¡ì•„ì¤˜|ì¼ì •|ë¯¸íŒ…|ì•½ì†|ì œì¶œí•˜ê¸°/g, '').trim();
            }

            title = title || 'ìƒˆë¡œìš´ í•  ì¼';
            const task = { 'title': title };
            if (dueDate) task.due = dueDate.toISOString();
            
            statusMessage.textContent = `â³ ì €ì¥ ì¤‘...`;

            gapi.client.tasks.tasks.insert({
                'tasklist': '@default',
                'resource': task
            }).then((response) => {
                statusMessage.textContent = `âœ… ì €ì¥ ì™„ë£Œ! (${response.result.title})`;
                document.getElementById('voice-result').textContent = '';
                document.getElementById('text-input').value = '';
                loadTasksList();
            }).catch((err) => {
                statusMessage.textContent = `âŒ ì €ì¥ ì‹¤íŒ¨: ${err.result.error.message}`;
            });
        }
    </script>
</body>
</html>
