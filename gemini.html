<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„œì§„í…Œí¬ AI ì¼ì • ê´€ë¦¬ (Pro)</title>
    <style>
        body { 
            font-family: 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', sans-serif; 
            max-width: 600px; margin: 0 auto; padding: 20px; 
            background-color: #f4f7f9; border-radius: 8px; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        h1 { color: #333; border-bottom: 3px solid #007bff; padding-bottom: 10px; margin-bottom: 20px; text-align: center; }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .header-buttons { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        button { padding: 10px 20px; cursor: pointer; border: none; border-radius: 5px; font-weight: bold; transition: background-color 0.3s; font-size: 14px; }
        button:disabled { background-color: #cccccc !important; cursor: not-allowed; color: #666666 !important; }

        #start-voice-btn { background-color: #007bff; color: white; }
        #start-voice-btn:hover { background-color: #0056b3; }
        #login-btn { background-color: #6c757d; color: white; }
        #login-btn:hover { background-color: #5a6268; }
        #login-btn.logout-mode { background-color: #dc3545; }
        #submit-text-btn { background-color: #28a745; color: white; width: 100%; margin-top: 5px; }
        #submit-text-btn:hover { background-color: #1e7e34; }

        .input-area { margin-bottom: 20px; }
        input[type="text"] { padding: 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; box-sizing: border-box; width: 100%; margin-bottom: 5px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        
        #voice-result { font-weight: bold; color: #d9534f; display: block; margin-bottom: 10px; min-height: 20px; }
        #status-message { color: #007bff; margin-top: 10px; font-size: 0.95em; padding: 10px; border: 1px solid #cce5ff; background-color: #e2f0ff; border-radius: 5px; text-align: center; }

        /* ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .task-section { background: white; margin-top: 20px; padding: 15px; border-radius: 8px; border: 1px solid #ddd; }
        .task-section h3 { margin-top: 0; font-size: 1.1em; color: #444; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        ul { padding-left: 20px; margin-bottom: 0; }
        li { margin-bottom: 8px; color: #555; line-height: 1.4; }
        .time-badge { font-size: 0.8em; background-color: #e2f0ff; color: #007bff; padding: 2px 6px; border-radius: 4px; margin-right: 6px; font-weight: bold; }

        /* ì¶”ì²œ ìŠ¬ë¡¯ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        #recommendation-area { display: none; margin-top: 15px; padding: 10px; background-color: #fff3cd; border: 1px solid #ffeeba; border-radius: 8px; }
        .slot-btn { background-color: #ffc107; color: #333; margin: 5px; padding: 8px 12px; border-radius: 20px; font-size: 0.9em; border: 1px solid #e0a800; }
        .slot-btn:hover { background-color: #e0a800; }

        .calendar-container { margin-top: 30px; position: relative; padding-bottom: 75%; height: 0; overflow: hidden; border: 1px solid #ccc; border-radius: 8px; }
        .calendar-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #user-info { text-align: right; font-size: 0.8em; color: #888; margin-bottom: 5px; }
    </style>
</head>
<body>
    <h1>ğŸ“… ì„œì§„í…Œí¬ AI ì¼ì • ê´€ë¦¬ (Pro)</h1>
    <div id="user-info"></div>

    <div class="header-buttons">
        <button id="start-voice-btn" disabled>ğŸ¤ ë§í•˜ê¸°</button>
        <button id="login-btn" disabled>ğŸ”„ ë¡œë”© ì¤‘...</button>
    </div>

    <div class="input-area">
        <p>ì¸ì‹ëœ ë‚´ìš©: <span id="voice-result"></span></p>
        <label for="text-input">í…ìŠ¤íŠ¸ ì…ë ¥:</label>
        <input type="text" id="text-input" placeholder="ì˜ˆ: ë‚´ì¼ ë¹ˆ ì‹œê°„ ì¶”ì²œí•´ì¤˜">
        <button id="submit-text-btn" disabled>ì „ì†¡</button>
    </div>

    <div id="recommendation-area">
        <h3>âš¡ ì¶”ì²œëœ ë¹ˆ ì‹œê°„ (í´ë¦­í•˜ì—¬ ìŠ¹ì¸)</h3>
        <div id="slots-container"></div>
    </div>

    <p id="status-message">â³ ì‹œìŠ¤í…œ ì—°ê²° ëŒ€ê¸° ì¤‘...</p>
    
    <div class="task-section">
        <h3>â˜€ï¸ ì˜¤ëŠ˜ ë‚˜ì˜ ì¼ì • (Today)</h3>
        <ul id="today-list"><li>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</li></ul>
    </div>

    <div class="task-section">
        <h3>ğŸ—“ï¸ ì´ë²ˆ ì£¼ ë‚˜ì˜ ì¼ì • (This Week)</h3>
        <ul id="week-list"><li>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</li></ul>
    </div>

    <div class="calendar-container">
        <iframe src="https://calendar.google.com/calendar/embed?src=cce03f167bf28bafd3795833209784265eadca0ed8138cae7d9024470ad36c66%40group.calendar.google.com&ctz=Asia%2FSeoul" style="border: 0" frameborder="0" scrolling="no"></iframe>
    </div>

    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>

    <script>
        // ğŸš¨ ì„¤ì •: ë³¸ì¸ì˜ IDë¥¼ í™•ì¸í•˜ì„¸ìš”
        const CLIENT_ID = '1049915608396-i3jn8jrm24bc9mkagdtokk3rfa3li513.apps.googleusercontent.com'; 
        const CALENDAR_ID = 'cce03f167bf28bafd3795833209784265eadca0ed8138cae7d9024470ad36c66@group.calendar.google.com';

        const SCOPES = 'https://www.googleapis.com/auth/calendar.events https://www.googleapis.com/auth/userinfo.email'; 
        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"];

        let tokenClient;
        let gapiInited = false, gisInited = false;
        let userEmail = '';

        // DOM ìš”ì†Œ
        const statusMessage = document.getElementById('status-message');
        const loginBtn = document.getElementById('login-btn');
        const voiceBtn = document.getElementById('start-voice-btn');
        const submitBtn = document.getElementById('submit-text-btn');
        const userInfoDiv = document.getElementById('user-info');
        const todayList = document.getElementById('today-list');
        const weekList = document.getElementById('week-list');
        const recArea = document.getElementById('recommendation-area');
        const slotsContainer = document.getElementById('slots-container');

        function gapiLoaded() { gapi.load('client', intializeGapiClient); }
        function gisLoaded() { 
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID, scope: SCOPES, callback: '', 
            });
            gisInited = true; maybeEnableButtons();
        }
        async function intializeGapiClient() {
            await gapi.client.init({ discoveryDocs: DISCOVERY_DOCS });
            gapiInited = true; maybeEnableButtons();
        }
        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                const savedToken = localStorage.getItem('access_token');
                if (savedToken) {
                    gapi.client.setToken({access_token: savedToken});
                    fetchUserInfo(true);
                } else {
                    setLoginState(false);
                }
            }
        }

        function fetchUserInfo(isAutoLogin) {
            statusMessage.textContent = "ğŸ”„ ì‚¬ìš©ì ì •ë³´ í™•ì¸ ì¤‘...";
            fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
                headers: { 'Authorization': `Bearer ${gapi.client.getToken().access_token}` }
            }).then(res => {
                if (!res.ok) throw new Error('Session expired');
                return res.json();
            }).then(data => {
                userEmail = data.email;
                userInfoDiv.textContent = `${data.name}ë‹˜ ë¡œê·¸ì¸ ì¤‘`;
                setLoginState(true);
                loadEventsList();
                if(!isAutoLogin) statusMessage.textContent = `âœ… í™˜ì˜í•©ë‹ˆë‹¤, ${data.name}ë‹˜!`;
            }).catch(() => handleLogout());
        }

        function setLoginState(isLoggedIn) {
            if (isLoggedIn) {
                loginBtn.textContent = "ğŸšª ë¡œê·¸ì•„ì›ƒ"; loginBtn.classList.add('logout-mode');
                loginBtn.onclick = handleLogout;
                [loginBtn, voiceBtn, submitBtn].forEach(b => b.disabled = false);
            } else {
                loginBtn.textContent = "ğŸ”‘ ë¡œê·¸ì¸"; loginBtn.classList.remove('logout-mode');
                loginBtn.onclick = handleLogin;
                voiceBtn.disabled = true; submitBtn.disabled = true;
                userInfoDiv.textContent = "";
                statusMessage.textContent = "âœ… ì¤€ë¹„ ì™„ë£Œ. ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.";
            }
        }
        function handleLogin() {
            tokenClient.callback = (resp) => {
                if (resp.error) throw (resp);
                localStorage.setItem('access_token', resp.access_token);
                fetchUserInfo(false);
            };
            tokenClient.requestAccessToken({prompt: 'consent'});
        }
        function handleLogout() {
            const token = gapi.client.getToken();
            if (token) google.accounts.oauth2.revoke(token.access_token);
            gapi.client.setToken('');
            localStorage.removeItem('access_token');
            setLoginState(false);
        }

        // --- ğŸ§  AI ë¹„ì„œ í•µì‹¬ ë¡œì§ (ë¶„ê¸° ì²˜ë¦¬) ---
        function processInput(text) {
            if (!text.trim()) return;

            // 1. "ì¶”ì²œ", "ë¹ˆ ì‹œê°„", "ì–¸ì œ" ê°™ì€ í‚¤ì›Œë“œê°€ ìˆìœ¼ë©´ -> ì¶”ì²œ ëª¨ë“œ ì‹¤í–‰
            if (text.includes('ì¶”ì²œ') || text.includes('ë¹ˆ ì‹œê°„') || text.includes('ì–¸ì œ')) {
                findFreeSlots(text);
            } 
            // 2. ê·¸ ì™¸ì—ëŠ” -> ì¼ì • ì €ì¥ ëª¨ë“œ ì‹¤í–‰
            else {
                processSchedule(text);
            }
        }

        // ğŸ“… ë¹ˆ ì‹œê°„ ì¶”ì²œ ì•Œê³ ë¦¬ì¦˜
        async function findFreeSlots(text) {
            statusMessage.textContent = "ğŸ” ë¹ˆ ì‹œê°„ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...";
            recArea.style.display = 'none';
            
            let targetDate = new Date();
            if (text.includes('ë‚´ì¼')) targetDate.setDate(targetDate.getDate() + 1);
            
            // ê²€ìƒ‰ ë²”ìœ„: ì˜¤ì „ 9ì‹œ ~ ì˜¤í›„ 6ì‹œ
            const workStartHour = 9;
            const workEndHour = 18;

            const timeMin = new Date(targetDate); timeMin.setHours(workStartHour, 0, 0, 0);
            const timeMax = new Date(targetDate); timeMax.setHours(workEndHour, 0, 0, 0);

            try {
                // í•´ë‹¹ ë‚ ì§œì˜ ì¼ì • ê°€ì ¸ì˜¤ê¸°
                const response = await gapi.client.calendar.events.list({
                    'calendarId': CALENDAR_ID,
                    'timeMin': timeMin.toISOString(),
                    'timeMax': timeMax.toISOString(),
                    'singleEvents': true,
                    'orderBy': 'startTime'
                });

                const busyEvents = response.result.items || [];
                const freeSlots = [];
                let currentPointer = new Date(timeMin);

                // 1ì‹œê°„ ë‹¨ìœ„ë¡œ ë¹ˆ ì‹œê°„ ì²´í¬
                while (currentPointer.getHours() < workEndHour) {
                    let nextPointer = new Date(currentPointer);
                    nextPointer.setHours(currentPointer.getHours() + 1);

                    // ì¶©ëŒ í™•ì¸
                    let isBusy = false;
                    for (let event of busyEvents) {
                        const eventStart = new Date(event.start.dateTime || event.start.date);
                        const eventEnd = new Date(event.end.dateTime || event.end.date);
                        
                        // ê²¹ì¹˜ëŠ”ì§€ í™•ì¸ (ë‚´ ì‹œê°„ì´ ì´ë²¤íŠ¸ ì‚¬ì´ì— ìˆê±°ë‚˜ ê±¸ì³ìˆìœ¼ë©´)
                        if (currentPointer < eventEnd && nextPointer > eventStart) {
                            isBusy = true;
                            break;
                        }
                    }

                    if (!isBusy) {
                        freeSlots.push(new Date(currentPointer));
                    }
                    
                    // 1ì‹œê°„ì”© ì´ë™
                    currentPointer.setHours(currentPointer.getHours() + 1);
                }

                showRecommendations(freeSlots);

            } catch (err) {
                statusMessage.textContent = "âŒ ë¶„ì„ ì‹¤íŒ¨: " + err.message;
            }
        }

        function showRecommendations(slots) {
            slotsContainer.innerHTML = '';
            if (slots.length === 0) {
                statusMessage.textContent = "âš ï¸ í•´ë‹¹ ë‚ ì§œì— ë¹ˆ ì‹œê°„ì´ ì—†ìŠµë‹ˆë‹¤.";
                return;
            }

            recArea.style.display = 'block';
            statusMessage.textContent = `âœ… ${slots.length}ê°œì˜ ë¹ˆ ì‹œê°„ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤! ì›í•˜ëŠ” ì‹œê°„ì„ í´ë¦­í•˜ì„¸ìš”.`;

            slots.forEach(slot => {
                const timeStr = slot.getHours() + ":00";
                const btn = document.createElement('button');
                btn.className = 'slot-btn';
                btn.textContent = timeStr;
                
                // ì¶”ì²œ ìŠ¬ë¡¯ í´ë¦­ ì‹œ -> ì¼ì • ìŠ¹ì¸(ì €ì¥)
                btn.onclick = () => {
                    const dateStr = (slot.getMonth()+1) + "ì›” " + slot.getDate() + "ì¼";
                    const saveText = `${dateStr} ${timeStr}ì— ë¯¸íŒ… ì¼ì • ì¡ì•„ì¤˜`;
                    recArea.style.display = 'none'; // ì¶”ì²œì°½ ë‹«ê¸°
                    processSchedule(saveText); // ì €ì¥ ì‹¤í–‰
                };
                slotsContainer.appendChild(btn);
            });
        }

        // ğŸ’¾ ì¼ì • ì €ì¥ ë¡œì§
        function processSchedule(text) {
            let summary = text.replace('ì¼ì • ì¡ì•„ì¤˜', '').replace('ì— ë¯¸íŒ…', '').trim();
            let startDate = new Date();
            
            // ë‚ ì§œ íŒŒì‹± (Mì›” Dì¼ íŒ¨í„´ ì¶”ê°€)
            const dateMatch = text.match(/(\d+)ì›”\s*(\d+)ì¼/);
            if (dateMatch) {
                startDate.setMonth(parseInt(dateMatch[1]) - 1);
                startDate.setDate(parseInt(dateMatch[2]));
            } else if (text.includes('ë‚´ì¼')) {
                startDate.setDate(startDate.getDate() + 1);
                summary = summary.replace('ë‚´ì¼', '').trim();
            } else if (text.includes('ì˜¤ëŠ˜')) {
                summary = summary.replace('ì˜¤ëŠ˜', '').trim();
            }

            const timeMatch = text.match(/(ì˜¤ì „|ì˜¤í›„)?\s*(\d{1,2})[:ì‹œ]/); 
            if (timeMatch) {
                let hour = parseInt(timeMatch[2]);
                if (timeMatch[1] === 'ì˜¤í›„' && hour < 12) hour += 12;
                else if (timeMatch[1] === 'ì˜¤ì „' && hour === 12) hour = 0;
                startDate.setHours(hour, 0, 0, 0);
                summary = summary.replace(timeMatch[0], '').trim(); // ì‹œê°„ í…ìŠ¤íŠ¸ ì œê±°
            } else {
                startDate.setHours(startDate.getHours() + 1, 0, 0, 0);
            }

            let endDate = new Date(startDate);
            endDate.setHours(startDate.getHours() + 1);

            // ì œëª©ì´ ë„ˆë¬´ ë¹„ì–´ìˆìœ¼ë©´ ê¸°ë³¸ê°’
            if (summary.length < 2 || summary.includes(':')) summary = 'ìƒˆë¡œìš´ ì¼ì •';

            const event = {
                'summary': summary,
                'start': { 'dateTime': startDate.toISOString() },
                'end': { 'dateTime': endDate.toISOString() },
                'description': `Created by: ${userEmail}` 
            };

            statusMessage.textContent = `â³ ì €ì¥ ì¤‘: ${summary}...`;

            gapi.client.calendar.events.insert({
                'calendarId': CALENDAR_ID, 'resource': event
            }).then(() => {
                statusMessage.textContent = `âœ… ì¼ì • ìŠ¹ì¸ ì™„ë£Œ! (${summary})`;
                loadEventsList(); 
                const iframe = document.querySelector('.calendar-container iframe');
                iframe.src = iframe.src; 
            }).catch(err => {
                statusMessage.textContent = `âŒ ì €ì¥ ì‹¤íŒ¨: ${err.result.error.message}`;
            });
        }

        // ğŸ“‹ ë¦¬ìŠ¤íŠ¸ ë¡œë”© (í•„í„°ë§)
        async function loadEventsList() {
            if (!userEmail) return;
            try {
                const now = new Date();
                const startOfWeek = new Date(now); startOfWeek.setHours(0,0,0,0);
                const endOfWeek = new Date(now); endOfWeek.setDate(now.getDate() + 7);

                const res = await gapi.client.calendar.events.list({
                    'calendarId': CALENDAR_ID,
                    'timeMin': startOfWeek.toISOString(), 'timeMax': endOfWeek.toISOString(),
                    'singleEvents': true, 'orderBy': 'startTime'
                });

                todayList.innerHTML = ''; weekList.innerHTML = '';
                let tCount = 0, wCount = 0;

                (res.result.items || []).forEach(event => {
                    if (event.creator.email === userEmail) {
                        const start = new Date(event.start.dateTime || event.start.date);
                        const timeStr = start.getHours().toString().padStart(2, '0') + ':' + start.getMinutes().toString().padStart(2, '0');
                        const li = document.createElement('li');
                        
                        if (start.toDateString() === now.toDateString()) {
                            li.innerHTML = `<span class="time-badge">${timeStr}</span> ${event.summary}`;
                            todayList.appendChild(li); tCount++;
                        } else {
                            const dateStr = (start.getMonth()+1) + "/" + start.getDate();
                            li.innerHTML = `<span class="time-badge">${dateStr} ${timeStr}</span> ${event.summary}`;
                            weekList.appendChild(li); wCount++;
                        }
                    }
                });
                if (tCount===0) todayList.innerHTML = '<li>ì¼ì • ì—†ìŒ</li>';
                if (wCount===0) weekList.innerHTML = '<li>ì¼ì • ì—†ìŒ</li>';
            } catch (e) { console.error(e); }
        }

        // ğŸ¤ ìŒì„± ì¸ì‹
        function startVoiceRecognition() {
            if (!('webkitSpeechRecognition' in window)) { statusMessage.textContent = 'âš ï¸ ë¯¸ì§€ì› ë¸Œë¼ìš°ì €'; return; }
            const recognition = new webkitSpeechRecognition();
            recognition.lang = 'ko-KR'; recognition.continuous = false; recognition.interimResults = false;
            statusMessage.textContent = 'ğŸ¤ ë“£ê³  ìˆìŠµë‹ˆë‹¤...';
            recognition.start();
            recognition.onresult = (e) => {
                const txt = e.results[0][0].transcript;
                document.getElementById('voice-result').textContent = txt;
                processInput(txt); // ìˆ˜ì •ë¨: processSchedule -> processInput
            };
        }

        voiceBtn.onclick = startVoiceRecognition;
        submitBtn.onclick = () => processInput(document.getElementById('text-input').value); // ìˆ˜ì •ë¨

        gapiLoaded(); gisLoaded();
    </script>
</body>
</html>
