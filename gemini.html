<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„œì§„í…Œí¬ AI ì¼ì • ê´€ë¦¬</title>
    <style>
        body { 
            font-family: 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', sans-serif; 
            max-width: 600px; 
            margin: 0 auto; 
            padding: 20px; 
            background-color: #f4f7f9;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #007bff;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        button {
            padding: 10px 20px; 
            cursor: pointer; 
            margin-top: 10px; 
            border: none;
            border-radius: 5px;
            font-weight: bold;
            transition: background-color 0.3s;
            margin-right: 5px;
        }
        button:disabled {
            background-color: #cccccc !important;
            cursor: not-allowed;
            color: #666666 !important;
        }

        #start-voice-btn { background-color: #007bff; color: white; }
        #start-voice-btn:hover { background-color: #0056b3; }
        
        #submit-text-btn { background-color: #28a745; color: white; }
        #submit-text-btn:hover { background-color: #1e7e34; }

        /* ë¡œê·¸ì¸ ë²„íŠ¼ (ê¸°ë³¸ íŒŒë€ ê³„ì—´) */
        #login-btn { background-color: #6c757d; color: white; }
        #login-btn:hover { background-color: #5a6268; }

        /* ë¡œê·¸ì•„ì›ƒ ìƒíƒœì¼ ë•Œ ìŠ¤íƒ€ì¼ (ë¹¨ê°„ ê³„ì—´) */
        #login-btn.logout-mode { background-color: #dc3545; }
        #login-btn.logout-mode:hover { background-color: #c82333; }
        
        .task-section {
            background: white;
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .task-section h3 {
            margin-top: 0;
            color: #444;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        ul { padding-left: 20px; }
        li { margin-bottom: 8px; color: #555; line-height: 1.4; }
        .time-badge {
            font-size: 0.8em;
            background-color: #e2f0ff;
            color: #007bff;
            padding: 2px 6px;
            border-radius: 4px;
            margin-right: 6px;
            font-weight: bold;
        }

        #voice-result { font-weight: bold; color: #d9534f; display: block; margin-top: 5px; }
        #status-message { 
            color: #007bff; margin-top: 15px; font-size: 1.1em; padding: 10px; 
            border: 1px solid #cce5ff; background-color: #e2f0ff; border-radius: 5px; 
        }
        input[type="text"] {
            padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; 
            box-sizing: border-box; width: 70%;
        }
        
        .calendar-container {
            margin-top: 30px; position: relative; padding-bottom: 75%; height: 0; overflow: hidden;
        }
        .calendar-container iframe {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        }
    </style>
</head>
<body>
    <h1>ğŸ“… ì„œì§„í…Œí¬ AIì¼ì • ê´€ë¦¬</h1>
    
    <button id="login-btn" disabled>ğŸ”„ ì‹œìŠ¤í…œ ë¡œë”© ì¤‘...</button>
    <br><br>

    <button id="start-voice-btn" disabled>ğŸ¤ ë§í•˜ê¸°</button>
    <p>ì¸ì‹ëœ ë‚´ìš©: <span id="voice-result"></span></p>

    <hr>

    <label for="text-input" style="display:block; margin-bottom:5px; font-weight:bold;">í…ìŠ¤íŠ¸ ì…ë ¥:</label>
    <input type="text" id="text-input" placeholder="ì˜ˆ: ë‚´ì¼ ì˜¤í›„ 3ì‹œì— ë¯¸íŒ… ì¼ì • ì¡ì•„ì¤˜">
    <button id="submit-text-btn" disabled>ì¼ì • ì¶”ê°€</button>

    <p id="status-message">â³ ì‹œìŠ¤í…œ ì—°ê²° ëŒ€ê¸° ì¤‘...</p>
    
    <div class="task-section">
        <h3>â˜€ï¸ ì˜¤ëŠ˜ ì¼ì • (Today)</h3>
        <ul id="today-list"><li>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</li></ul>
    </div>

    <div class="task-section">
        <h3>ğŸ—“ï¸ ì´ë²ˆ ì£¼ ì¼ì • (This Week)</h3>
        <ul id="week-list"><li>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</li></ul>
    </div>

    <div class="calendar-container">
        <iframe src="https://calendar.google.com/calendar/embed?src=cce03f167bf28bafd3795833209784265eadca0ed8138cae7d9024470ad36c66%40group.calendar.google.com&ctz=Asia%2FSeoul" style="border: 0" frameborder="0" scrolling="no"></iframe>
    </div>

    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>

    <script>
        /* ==============================================================
           ğŸš¨ [ì„¤ì •] 
           1. CLIENT_ID: OAuth 2.0 í´ë¼ì´ì–¸íŠ¸ ID (10499...ë¡œ ì‹œì‘)
           2. CALENDAR_ID: ìƒˆë¡œ ë§Œë“œì‹  ìº˜ë¦°ë” ID (cce03f...ë¡œ ì‹œì‘)
           ============================================================== */
        const CLIENT_ID = '1049915608396-4saprmlim0i9t9jv2dhkje4eq6uqqlnr.apps.googleusercontent.com'; 
        const CALENDAR_ID = 'cce03f167bf28bafd3795833209784265eadca0ed8138cae7d9024470ad36c66@group.calendar.google.com';

        // Tasks API ëŒ€ì‹  Calendar APIë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
        const SCOPES = 'https://www.googleapis.com/auth/calendar.events'; 
        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"];

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let isLoggedIn = false; // ë¡œê·¸ì¸ ìƒíƒœ ì¶”ì 

        const statusMessage = document.getElementById('status-message');
        const loginBtn = document.getElementById('login-btn');
        const voiceBtn = document.getElementById('start-voice-btn');
        const submitBtn = document.getElementById('submit-text-btn');
        const todayList = document.getElementById('today-list');
        const weekList = document.getElementById('week-list');

        // --- 1. ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ë° ì´ˆê¸°í™” ---
        function gapiLoaded() { gapi.load('client', intializeGapiClient); }
        function gisLoaded() { 
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '', // ë™ì  í• ë‹¹
            });
            gisInited = true;
            maybeEnableButtons();
        }

        async function intializeGapiClient() {
            await gapi.client.init({ discoveryDocs: DISCOVERY_DOCS });
            gapiInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                // ì„¸ì…˜ ë³µêµ¬ ì‹œë„ (localStorage í™•ì¸)
                const savedLogin = localStorage.getItem('is_custom_logged_in');
                
                if (savedLogin === 'true') {
                    // í† í°ì´ ìœ íš¨í•œì§€ í™•ì¸ì€ ì–´ë µì§€ë§Œ, ë¡œê·¸ì¸ ìƒíƒœë¼ê³  ê°€ì •í•˜ê³  ì‹œë„
                    isLoggedIn = true;
                    updateLoginUI();
                    
                    // í† í°ì´ ë§Œë£Œë˜ì—ˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ í† í° ìš”ì²­ ì‹œë„ (ì¡°ìš©íˆ)
                    if (gapi.client.getToken() === null) {
                        tokenClient.requestAccessToken({prompt: ''}); 
                        tokenClient.callback = (resp) => {
                            if (resp.error) {
                                // í† í° ê°±ì‹  ì‹¤íŒ¨ ì‹œ ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
                                handleLogout();
                            } else {
                                loadEventsList();
                            }
                        };
                    } else {
                        loadEventsList();
                    }
                } else {
                    // ë¡œê·¸ì¸ ì•ˆ ëœ ìƒíƒœ
                    loginBtn.disabled = false;
                    loginBtn.textContent = "ğŸ”‘ êµ¬ê¸€ ë¡œê·¸ì¸";
                    statusMessage.textContent = "âœ… ì¤€ë¹„ ì™„ë£Œ. ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.";
                }
            }
        }

        // --- 2. ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ ---
        
        function updateLoginUI() {
            if (isLoggedIn) {
                loginBtn.textContent = "ğŸšª ë¡œê·¸ì•„ì›ƒ";
                loginBtn.classList.add('logout-mode');
                loginBtn.disabled = false;
                voiceBtn.disabled = false;
                submitBtn.disabled = false;
                statusMessage.textContent = "âœ… ë¡œê·¸ì¸ ë˜ì—ˆìŠµë‹ˆë‹¤. ì¼ì •ì„ ë§ì”€í•´ì£¼ì„¸ìš”.";
            } else {
                loginBtn.textContent = "ğŸ”‘ êµ¬ê¸€ ë¡œê·¸ì¸";
                loginBtn.classList.remove('logout-mode');
                loginBtn.disabled = false;
                voiceBtn.disabled = true;
                submitBtn.disabled = true;
                statusMessage.textContent = "ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.";
                todayList.innerHTML = '<li>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</li>';
                weekList.innerHTML = '<li>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</li>';
            }
        }

        function handleLoginClick() {
            if (isLoggedIn) {
                handleLogout();
            } else {
                handleLogin();
            }
        }

        function handleLogin() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) throw (resp);
                
                // ë¡œê·¸ì¸ ì„±ê³µ ì²˜ë¦¬
                isLoggedIn = true;
                localStorage.setItem('is_custom_logged_in', 'true'); // ì„¸ì…˜ ì €ì¥
                updateLoginUI();
                loadEventsList();
            };
            // íŒì—… ë„ìš°ê¸°
            tokenClient.requestAccessToken({prompt: 'consent'});
        }

        function handleLogout() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
            }
            isLoggedIn = false;
            localStorage.removeItem('is_custom_logged_in'); // ì„¸ì…˜ ì‚­ì œ
            updateLoginUI();
        }

        // --- 3. ì¼ì •(Calendar) ê´€ë ¨ ë¡œì§ ---

        // ì¼ì • ì¶”ê°€ (ìº˜ë¦°ë”ì— ì¶”ê°€ë˜ì–´ì•¼ iframeì— ë³´ì„)
        function processSchedule(text) {
            if (!text.trim()) { statusMessage.textContent = 'âš ï¸ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.'; return; }

            let summary = text;
            let startDate = new Date();
            
            // ë‚ ì§œ íŒŒì‹± (ê°„ë‹¨ ë²„ì „)
            if (text.includes('ë‚´ì¼')) {
                startDate.setDate(startDate.getDate() + 1);
                summary = summary.replace('ë‚´ì¼', '').trim();
            } else if (text.includes('ì˜¤ëŠ˜')) {
                summary = summary.replace('ì˜¤ëŠ˜', '').trim();
            }

            // ì‹œê°„ íŒŒì‹±
            const timeMatch = text.match(/(ì˜¤ì „|ì˜¤í›„)?\s*(\d{1,2})\s*ì‹œ/); 
            if (timeMatch) {
                let hour = parseInt(timeMatch[2]);
                if (timeMatch[1] === 'ì˜¤í›„' && hour < 12) hour += 12;
                else if (timeMatch[1] === 'ì˜¤ì „' && hour === 12) hour = 0;
                startDate.setHours(hour, 0, 0, 0);
                summary = summary.replace(timeMatch[0], '').replace(/ì—|ì‹œê°„ì—|ì¡ì•„ì¤˜|ì¼ì •|ë¯¸íŒ…/g, '').trim();
            } else {
                // ì‹œê°„ ì—†ìœ¼ë©´ í˜„ì¬ ì‹œê°„ì˜ ë‹¤ìŒ ì •ê°ìœ¼ë¡œ ì„¤ì •
                startDate.setHours(startDate.getHours() + 1, 0, 0, 0);
            }

            // ì¢…ë£Œ ì‹œê°„ (ê¸°ë³¸ 1ì‹œê°„)
            let endDate = new Date(startDate);
            endDate.setHours(startDate.getHours() + 1);

            const event = {
                'summary': summary || 'ìƒˆë¡œìš´ ì¼ì •',
                'start': { 'dateTime': startDate.toISOString() },
                'end': { 'dateTime': endDate.toISOString() }
            };

            statusMessage.textContent = `â³ ìº˜ë¦°ë”ì— ì €ì¥ ì¤‘...`;

            gapi.client.calendar.events.insert({
                'calendarId': CALENDAR_ID, // íŠ¹ì • ìº˜ë¦°ë”ì— ì €ì¥
                'resource': event
            }).then((response) => {
                statusMessage.textContent = `âœ… ì €ì¥ ì™„ë£Œ! (${summary})`;
                document.getElementById('voice-result').textContent = '';
                document.getElementById('text-input').value = '';
                
                loadEventsList(); // ë¦¬ìŠ¤íŠ¸ ê°±ì‹ 
                
                // iframe ê°±ì‹ ì„ ìœ„í•´ src ì¬í• ë‹¹ (ê¹œë¹¡ì„ ë°œìƒí•  ìˆ˜ ìˆìŒ)
                const iframe = document.querySelector('.calendar-container iframe');
                iframe.src = iframe.src; 
                
            }).catch((err) => {
                statusMessage.textContent = `âŒ ì €ì¥ ì‹¤íŒ¨: ${err.result.error.message}`;
            });
        }

        // ì¼ì • ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadEventsList() {
            try {
                // ì˜¤ëŠ˜ 0ì‹œë¶€í„° 7ì¼ ë’¤ê¹Œì§€ ì¡°íšŒ
                const now = new Date();
                const startOfWeek = new Date(now); startOfWeek.setHours(0,0,0,0);
                const endOfWeek = new Date(now); endOfWeek.setDate(now.getDate() + 7);

                const response = await gapi.client.calendar.events.list({
                    'calendarId': CALENDAR_ID,
                    'timeMin': startOfWeek.toISOString(),
                    'timeMax': endOfWeek.toISOString(),
                    'showDeleted': false,
                    'singleEvents': true,
                    'orderBy': 'startTime'
                });

                const events = response.result.items || [];
                
                todayList.innerHTML = '';
                weekList.innerHTML = '';
                let todayCount = 0;
                let weekCount = 0;

                events.forEach(event => {
                    const start = event.start.dateTime || event.start.date;
                    const dateObj = new Date(start);
                    
                    // ì‹œê°„ í‘œì‹œ (HH:MM)
                    const timeStr = dateObj.getHours().toString().padStart(2, '0') + ':' + 
                                    dateObj.getMinutes().toString().padStart(2, '0');
                    
                    const li = document.createElement('li');
                    li.innerHTML = `<span class="time-badge">${timeStr}</span> ${event.summary}`;

                    // ì˜¤ëŠ˜ ì¼ì •ì¸ì§€ í™•ì¸
                    if (dateObj.toDateString() === now.toDateString()) {
                        todayList.appendChild(li);
                        todayCount++;
                    } else {
                        // ë‚ ì§œ í‘œì‹œ ì¶”ê°€ (MM/DD)
                        const dateStr = (dateObj.getMonth()+1) + "/" + dateObj.getDate();
                        li.innerHTML = `<span class="time-badge">${dateStr} ${timeStr}</span> ${event.summary}`;
                        weekList.appendChild(li);
                        weekCount++;
                    }
                });

                if (todayCount === 0) todayList.innerHTML = '<li>ì˜¤ëŠ˜ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
                if (weekCount === 0) weekList.innerHTML = '<li>ì´ë²ˆ ì£¼ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</li>';

            } catch (err) {
                console.error(err);
                statusMessage.textContent = "âŒ ì¼ì • ëª©ë¡ì„ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
            }
        }

        // --- 4. ìŒì„± ì¸ì‹ ---
        function startVoiceRecognition() {
            if (!('webkitSpeechRecognition' in window)) {
                statusMessage.textContent = 'âš ï¸ ìŒì„± ì¸ì‹ ë¯¸ì§€ì›'; return;
            }
            const recognition = new webkitSpeechRecognition();
            recognition.lang = 'ko-KR';
            recognition.continuous = false;
            recognition.interimResults = false;

            statusMessage.textContent = 'ğŸ¤ ë§ì”€í•´ì£¼ì„¸ìš”...';
            recognition.start();

            recognition.onresult = (event) => {
                const text = event.results[0][0].transcript;
                document.getElementById('voice-result').textContent = text;
                processSchedule(text);
            };
            recognition.onerror = (event) => {
                statusMessage.textContent = `âŒ ì˜¤ë¥˜: ${event.error}`;
            };
        }

        // ì´ë²¤íŠ¸ ì—°ê²°
        loginBtn.onclick = handleLoginClick;
        voiceBtn.onclick = startVoiceRecognition;
        submitBtn.onclick = () => processSchedule(document.getElementById('text-input').value);

        gapiLoaded();
        gisLoaded();
    </script>
</body>
</html>
