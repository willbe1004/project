<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„œì§„í…Œí¬ AI ì¼ì • ê´€ë¦¬</title>
    <style>
        body { 
            font-family: 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', sans-serif; 
            max-width: 600px; 
            margin: 0 auto; 
            padding: 20px; 
            background-color: #f4f7f9;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #007bff;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        button {
            padding: 10px 20px; 
            cursor: pointer; 
            margin-top: 10px; 
            border: none;
            border-radius: 5px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        #start-voice-btn { background-color: #007bff; color: white; }
        #start-voice-btn:hover { background-color: #0056b3; }
        #submit-text-btn { background-color: #28a745; color: white; }
        #submit-text-btn:hover { background-color: #1e7e34; }
        
        /* ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        .task-section {
            background: white;
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .task-section h3 {
            margin-top: 0;
            color: #444;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        ul { padding-left: 20px; }
        li { margin-bottom: 5px; color: #555; }
        .date-badge {
            font-size: 0.8em;
            background-color: #eee;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
            color: #666;
        }

        #voice-result { font-weight: bold; color: #d9534f; display: block; margin-top: 5px; }
        #status-message { 
            color: #007bff; margin-top: 15px; font-size: 1.1em; padding: 10px; 
            border: 1px solid #cce5ff; background-color: #e2f0ff; border-radius: 5px; 
        }
        input[type="text"] {
            padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; 
            box-sizing: border-box; width: 70%;
        }
        label { display: block; margin-top: 15px; margin-bottom: 5px; font-weight: bold; }
        
        /* ìº˜ë¦°ë” ì•„ì´í”„ë ˆì„ (í•„ìš”í•˜ë©´ ìœ ì§€, ì•„ë‹ˆë©´ ì‚­ì œ ê°€ëŠ¥) */
        .calendar-container {
            margin-top: 30px; position: relative; padding-bottom: 75%; height: 0; overflow: hidden;
        }
        .calendar-container iframe {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        }
    </style>
</head>
<body>
    <h1>ğŸ“ ì„œì§„í…Œí¬ AI ì¼ì • ê´€ë¦¬</h1>
    
    <button id="start-voice-btn">ğŸ¤ ë§í•˜ê¸°</button>
    <p>ì¸ì‹ëœ ë‚´ìš©: <span id="voice-result"></span></p>

    <hr>

    <label for="text-input">í…ìŠ¤íŠ¸ ì…ë ¥:</label>
    <input type="text" id="text-input" placeholder="ì˜ˆ: ë‚´ì¼ ì˜¤í›„ 3ì‹œì— ë³´ê³ ì„œ ì œì¶œí•˜ê¸°">
    <button id="submit-text-btn">í•  ì¼ ì¶”ê°€</button>

    <p id="status-message">ì‹œìŠ¤í…œ ì¤€ë¹„ ì¤‘...</p>
    
    <div class="task-section">
        <h3>ğŸ“… ì˜¤ëŠ˜ ì¼ì • (Today)</h3>
        <ul id="today-list"><li>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</li></ul>
    </div>

    <div class="task-section">
        <h3>ğŸ—“ï¸ ì´ë²ˆ ì£¼ ì¼ì • (This Week)</h3>
        <ul id="week-list"><li>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</li></ul>
    </div>

    <div class="calendar-container">
        <iframe src="https://calendar.google.com/calendar/embed?src=cce03f167bf28bafd3795833209784265eadca0ed8138cae7d9024470ad36c66%40group.calendar.google.com&ctz=Asia%2FSeoul" style="border: 0" frameborder="0" scrolling="no"></iframe>
    </div>

    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>

    <script>
        /* ğŸš¨ [ì„¤ì •] í´ë¼ì´ì–¸íŠ¸ ID (ê¸°ì¡´ì— ì“°ì‹œë˜ ê²ƒ ê·¸ëŒ€ë¡œ ë‘ì„¸ìš”) */
        const CLIENT_ID = '1049915608396-4saprmlim0i9t9jv2dhkje4eq6uqqlnr.apps.googleusercontent.com'; 

        const SCOPES = 'https://www.googleapis.com/auth/tasks'; 
        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/tasks/v1/rest"];

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;

        const statusMessage = document.getElementById('status-message');
        const voiceResult = document.getElementById('voice-result');
        const textInput = document.getElementById('text-input');
        const todayList = document.getElementById('today-list');
        const weekList = document.getElementById('week-list');

        function gapiLoaded() { gapi.load('client', intializeGapiClient); }

        async function intializeGapiClient() {
            await gapi.client.init({ discoveryDocs: DISCOVERY_DOCS });
            gapiInited = true;
            maybeEnableButtons();
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '',
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                statusMessage.textContent = "âœ… ì¤€ë¹„ ì™„ë£Œ. [ë§í•˜ê¸°] ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”.";
                
                // ë§Œì•½ ì´ë¯¸ ë¡œê·¸ì¸ ë˜ì–´ ìˆë‹¤ë©´ ë¦¬ìŠ¤íŠ¸ ë°”ë¡œ ë¶ˆëŸ¬ì˜¤ê¸°
                if (gapi.client.getToken() !== null) {
                    loadTasksList();
                }
            }
        }

        function handleAuthAndAction(actionCallback) {
            if (gapi.client.getToken() !== null) {
                actionCallback();
                return;
            }
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) throw (resp);
                statusMessage.textContent = "âœ… ë¡œê·¸ì¸ ì„±ê³µ!";
                actionCallback();
                loadTasksList(); // ë¡œê·¸ì¸ ì§í›„ ë¦¬ìŠ¤íŠ¸ ê°±ì‹ 
            };
            tokenClient.requestAccessToken({prompt: 'consent'});
        }

        gapiLoaded();
        gisLoaded();

        document.getElementById('start-voice-btn').onclick = () => {
            handleAuthAndAction(startVoiceRecognition);
        };

        document.getElementById('submit-text-btn').onclick = () => {
            handleAuthAndAction(() => processSchedule(textInput.value));
        };

        // --- ì¼ì •(í•  ì¼) ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜ ---
        async function loadTasksList() {
            try {
                const response = await gapi.client.tasks.tasks.list({
                    'tasklist': '@default',
                    'showCompleted': false,
                    'showHidden': false
                });
                
                const tasks = response.result.items || [];
                
                // ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”
                todayList.innerHTML = '';
                weekList.innerHTML = '';

                const today = new Date();
                today.setHours(0,0,0,0);
                
                const nextWeek = new Date();
                nextWeek.setDate(today.getDate() + 7);

                let todayCount = 0;
                let weekCount = 0;

                tasks.forEach(task => {
                    let li = document.createElement('li');
                    li.textContent = task.title;

                    if (task.due) {
                        // êµ¬ê¸€ Tasks ë‚ ì§œ í˜•ì‹ ì²˜ë¦¬
                        const dueDate = new Date(task.due);
                        // ì‹œê°„ ë³´ì • (Tasks APIëŠ” UTC ê¸°ì¤€ì´ë¼ í•œêµ­ ì‹œê°„ìœ¼ë¡œ ë§ì¶¤)
                        dueDate.setHours(0,0,0,0); 

                        // ë‚ ì§œ ë°°ì§€ í‘œì‹œ
                        const dateString = (dueDate.getMonth()+1) + "/" + dueDate.getDate();
                        li.innerHTML += ` <span class="date-badge">${dateString}</span>`;

                        // ë‚ ì§œ ë¹„êµ
                        // ì˜¤ëŠ˜ ì¼ì •
                        if (dueDate.toDateString() === today.toDateString()) {
                            todayList.appendChild(li);
                            todayCount++;
                        } 
                        // ì´ë²ˆ ì£¼ ì¼ì • (ì˜¤ëŠ˜ ì œì™¸ ~ 7ì¼ í›„)
                        else if (dueDate > today && dueDate <= nextWeek) {
                            weekList.appendChild(li);
                            weekCount++;
                        }
                    } else {
                        // ë‚ ì§œ ì—†ëŠ” í•  ì¼ì€ ê·¸ëƒ¥ ì´ë²ˆ ì£¼ ëª©ë¡ ë°‘ì— ì°¸ê³ ìš©ìœ¼ë¡œ (ì„ íƒ ì‚¬í•­)
                        // weekList.appendChild(li); 
                    }
                });

                if (todayCount === 0) todayList.innerHTML = '<li>ì˜¤ëŠ˜ ì˜ˆì •ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
                if (weekCount === 0) weekList.innerHTML = '<li>ì´ë²ˆ ì£¼ ì˜ˆì •ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</li>';

            } catch (err) {
                console.error(err);
                todayList.innerHTML = '<li>ì¼ì •ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</li>';
            }
        }

        // --- ìŒì„± ë° ì¼ì • ì¶”ê°€ ë¡œì§ ---
        function startVoiceRecognition() {
            if (!('webkitSpeechRecognition' in window)) {
                statusMessage.textContent = 'âš ï¸ ìŒì„± ì¸ì‹ ë¯¸ì§€ì› ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.';
                return;
            }
            const recognition = new webkitSpeechRecognition();
            recognition.lang = 'ko-KR';
            recognition.continuous = false;
            recognition.interimResults = false;

            statusMessage.textContent = 'ğŸ¤ ë“£ê³  ìˆìŠµë‹ˆë‹¤...';
            recognition.start();

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                voiceResult.textContent = transcript;
                processSchedule(transcript); 
            };
            recognition.onerror = (event) => {
                statusMessage.textContent = `âŒ ì˜¤ë¥˜: ${event.error}`;
            };
        }

        function processSchedule(text) {
            if (!text.trim()) { statusMessage.textContent = 'âš ï¸ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.'; return; }

            let title = text.replace(/ë‚´ì¼|ì˜¤ëŠ˜/g, '').trim();
            let dueDate = null; 

            if (text.includes('ë‚´ì¼')) {
                dueDate = new Date();
                dueDate.setDate(dueDate.getDate() + 1);
                dueDate.setHours(0, 0, 0, 0); 
            } else if (text.includes('ì˜¤ëŠ˜')) {
                dueDate = new Date();
                dueDate.setHours(0, 0, 0, 0); 
            }
            
            const timeMatch = text.match(/(ì˜¤ì „|ì˜¤í›„)?\s*(\d{1,2})\s*ì‹œ/); 
            if (timeMatch) {
                if (!dueDate) dueDate = new Date();
                let hour = parseInt(timeMatch[2]);
                const ampm = timeMatch[1];
                if (ampm === 'ì˜¤í›„' && hour < 12) hour += 12;
                else if (ampm === 'ì˜¤ì „' && hour === 12) hour = 0;
                dueDate.setHours(hour, 0, 0, 0);
                title = title.replace(timeMatch[0], '').replace(/(ì˜¤ì „|ì˜¤í›„)?\s*\d{1,2}\s*ì‹œ/g, '').replace(/ì—|ì‹œê°„ì—|ì¡ì•„ì¤˜|ì¼ì •|ë¯¸íŒ…|ì•½ì†|ì œì¶œí•˜ê¸°/g, '').trim();
            }

            title = title || 'ìƒˆë¡œìš´ í•  ì¼';
            const task = { 'title': title };
            if (dueDate) task.due = dueDate.toISOString();
            
            statusMessage.textContent = `â³ ì €ì¥ ì¤‘...`;

            gapi.client.tasks.tasks.insert({
                'tasklist': '@default',
                'resource': task
            }).then((response) => {
                statusMessage.textContent = `âœ… ì €ì¥ ì™„ë£Œ! (${response.result.title})`;
                voiceResult.textContent = '';
                textInput.value = '';
                // ì €ì¥ í›„ ë¦¬ìŠ¤íŠ¸ ìƒˆë¡œê³ ì¹¨
                loadTasksList();
            }).catch((err) => {
                statusMessage.textContent = `âŒ ì‹¤íŒ¨: ${err.result.error.message}`;
            });
        }
    </script>
</body>
</html>
